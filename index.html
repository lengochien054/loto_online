<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Loto Online</title>
  <style>
    body { background:#0b1c2d; color:white; font-family:Arial; text-align:center; }
    .box { background:#132b45; margin:20px auto; padding:20px; width:400px; border-radius:10px; }
    input, button { padding:10px; margin:5px; width:90%; }
    #gameArea { display:none; }
  </style>
</head>
<body>

<h1>Loto Online</h1>

<div class="box" id="hostLogin">
  <h2>Đăng nhập Host</h2>
  <input id="hostEmail" placeholder="Email">
  <input id="hostPassword" type="password" placeholder="Mật khẩu">
  <button onclick="loginHost()">Đăng nhập</button>
</div>

<div class="box" id="playerJoin">
  <h2>Người chơi</h2>
  <input id="playerName" placeholder="Tên của bạn">
  <input id="roomCodeInput" placeholder="Mã phòng">
  <button onclick="joinRoom()">Vào phòng</button>
</div>

<div id="gameArea">
  <h2>Phòng: <span id="roomCode"></span></h2>
  <button onclick="drawNumber()">Quay số</button>
  <p>Số vừa ra: <span id="lastNumber">-</span></p>
  <div id="grid"></div>
</div>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getDatabase, ref, set, push, onValue, update } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDsqMoyX9jSWhQ5l_a2a5XcDgrFVN-cvfQ",
  authDomain: "lotoonline.firebaseapp.com",
  databaseURL: "https://lotoonline-default-rtdb.firebaseio.com",
  projectId: "lotoonline",
  storageBucket: "lotoonline.firebasestorage.app",
  messagingSenderId: "252484108877",
  appId: "1:252484108877:web:a971f2ef0cbe8a38271204",
  measurementId: "G-8YBCGY9PFV"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let currentRoom = "";
  let playerName = "";
  let isHost = false;

  window.loginHost = function() {
    const email = hostEmail.value;
    const pass = hostPassword.value;

    signInWithEmailAndPassword(auth, email, pass)
      .then(() => {
        isHost = true;
        currentRoom = Math.random().toString(36).substring(2, 8).toUpperCase();
        roomCode.textContent = currentRoom;

        set(ref(db, "rooms/" + currentRoom), {
          numbers: [],
          last: null,
          count: 0
        });

        showGame();
      })
      .catch(err => alert(err.message));
  };

  window.joinRoom = function() {
    playerName = document.getElementById("playerName").value;
    currentRoom = roomCodeInput.value.toUpperCase();

    if (!playerName || !currentRoom) {
      alert("Nhập đủ thông tin");
      return;
    }

    roomCode.textContent = currentRoom;
    showGame();
  };

  function showGame() {
    hostLogin.style.display = "none";
    playerJoin.style.display = "none";
    gameArea.style.display = "block";
  }

  window.drawNumber = function() {
    if (!isHost) return;

    const roomRef = ref(db, "rooms/" + currentRoom);

    onValue(roomRef, snap => {
      const data = snap.val();
      let nums = data.numbers || [];
      let n;

      do {
        n = Math.floor(Math.random() * 90) + 1;
      } while (nums.includes(n));

      nums.push(n);

      update(roomRef, {
        numbers: nums,
        last: n,
        count: nums.length
      });
    }, { onlyOnce:true });
  };

  onValue(ref(db, "rooms"), snap => {
    const data = snap.val();
    if (!data || !data[currentRoom]) return;

    lastNumber.textContent = data[currentRoom].last || "-";
  });
</script>

</body>
</html>

