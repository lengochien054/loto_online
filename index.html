<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Lô Tô Online Pro</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family: Arial; background:#0b2c45; color:#fff; text-align:center; }
.box { background:#123; padding:15px; margin:10px; border-radius:10px; }
input, button { padding:8px; margin:5px; }
table { border-collapse:collapse; margin:auto; }
td { width:40px; height:40px; border:1px solid #fff; font-weight:bold; }
.marked { background:yellow; color:#000; }
#chatBox { height:150px; overflow-y:auto; background:#000; padding:5px; text-align:left; }
.playerBoard { margin:10px; display:inline-block; }
</style>
</head>

<body>

<h1>LÔ TÔ ONLINE PRO</h1>

<!-- LOGIN -->
<div id="login" class="box">
  <input id="name" placeholder="Tên của bạn">
  <select id="role">
    <option value="host">Host</option>
    <option value="player">Người chơi</option>
  </select>
  <button onclick="login()">Vào phòng</button>
</div>

<!-- HOST -->
<div id="host" class="box" style="display:none">
  <h3>HOST</h3>
  <p>Mã phòng: <span id="roomCode"></span></p>
  <h2 id="currentNumber">--</h2>
  <button onclick="callNumber()">Hô số</button>
  <button onclick="resetGame()">Reset</button>
</div>

<!-- PLAYER -->
<div id="player" class="box" style="display:none">
  <h3>NGƯỜI CHƠI</h3>
  <h2 id="playerNumber">--</h2>
  <table id="board"></table>
  <h2 id="status"></h2>
</div>

<!-- PLAYER LIST -->
<div id="playersBox" class="box">
  <h3>Danh sách người chơi</h3>
  <div id="playerList"></div>
</div>

<!-- CHAT -->
<div id="chat" class="box">
  <h3>Chat trong phòng</h3>
  <div id="chatBox"></div>
  <input id="chatInput" placeholder="Nhập tin nhắn">
  <button onclick="sendChat()">Gửi</button>
</div>

<!-- VIEW BOARDS -->
<div id="allBoards" class="box">
  <h3>Bảng số của mọi người</h3>
</div>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDsqMoyX9jSwQ5L_a2a5xCdgrFVN-cvfQ",
  authDomain: "lotoonline.firebaseapp.com",
  databaseURL: "https://lotoonline-default-rtdb.firebaseio.com",
  projectId: "lotoonline",
  storageBucket: "lotoonline.appspot.com",
  messagingSenderId: "252484108877",
  appId: "1:252484108877:web:a971f2ef0cbe8a38271204"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= GLOBAL ================= */
let room = "";
let role = "";
let userName = "";
let numbers = [];

/* ================= LOGIN ================= */
function login(){
  userName = document.getElementById("name").value;
  role = document.getElementById("role").value;

  if(!userName) return alert("Nhập tên!");

  if(role === "host"){
    room = Math.random().toString(36).substring(2,8).toUpperCase();
    roomCode.innerText = room;

    db.ref("rooms/"+room).set({
      numbers: [],
      players: {},
      boards: {},
      chat: {}
    });

    loginBox(false, true, false);
    listenRoom();
  } 
  else {
    room = prompt("Nhập mã phòng:");
    if(!room) return;

    db.ref("rooms/"+room+"/boards").once("value", snap=>{
      const boards = snap.val() || {};
      if(Object.keys(boards).length >= 20){
        alert("Phòng đã đủ bảng!");
        return;
      }

      const board = generateBoard();
      db.ref("rooms/"+room+"/boards/"+userName).set(board);
      db.ref("rooms/"+room+"/players/"+userName).set(true);

      loginBox(false, false, true);
      renderBoard(board);
      listenRoom();
    });
  }
}

function loginBox(login, host, player){
  document.getElementById("login").style.display = login?"block":"none";
  document.getElementById("host").style.display = host?"block":"none";
  document.getElementById("player").style.display = player?"block":"none";
}

/* ================= HOST ================= */
function callNumber(){
  let n;
  do {
    n = Math.floor(Math.random()*90)+1;
  } while(numbers.includes(n));

  numbers.push(n);
  db.ref("rooms/"+room+"/numbers").set(numbers);
  currentNumber.innerText = n;
}

function resetGame(){
  db.ref("rooms/"+room).remove();
  location.reload();
}

/* ================= PLAYER ================= */
function listenRoom(){
  db.ref("rooms/"+room).on("value", snap=>{
    const data = snap.val();
    if(!data) return;

    numbers = data.numbers || [];
    const last = numbers[numbers.length-1];
    if(last){
      playerNumber.innerText = last;
      autoMark(last);
    }

    updatePlayers(data.players || {});
    updateBoards(data.boards || {});
    updateChat(data.chat || {});
  });
}

function autoMark(num){
  document.querySelectorAll("td").forEach(td=>{
    if(td.innerText == num){
      td.classList.add("marked");
    }
  });
  checkWin();
}

/* ================= CHAT ================= */
function sendChat(){
  const msg = chatInput.value;
  if(!msg) return;

  db.ref("rooms/"+room+"/chat").push({
    name: userName,
    text: msg
  });

  chatInput.value="";
}

function updateChat(chat){
  chatBox.innerHTML="";
  Object.values(chat).forEach(m=>{
    chatBox.innerHTML += `<div><b>${m.name}:</b> ${m.text}</div>`;
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}

/* ================= PLAYER LIST ================= */
function updatePlayers(players){
  playerList.innerHTML="";
  Object.keys(players).forEach(p=>{
    playerList.innerHTML += `<div>${p}</div>`;
  });
}

/* ================= BOARDS VIEW ================= */
function updateBoards(boards){
  allBoards.innerHTML="<h3>Bảng số của mọi người</h3>";

  Object.keys(boards).forEach(p=>{
    const div=document.createElement("div");
    div.className="playerBoard";
    div.innerHTML="<b>"+p+"</b>";

    const table=document.createElement("table");

    boards[p].forEach(r=>{
      let tr=document.createElement("tr");
      r.forEach(c=>{
        let td=document.createElement("td");
        td.innerText=c;
        tr.appendChild(td);
      });
      table.appendChild(tr);
    });

    div.appendChild(table);
    allBoards.appendChild(div);
  });
}

/* ================= BOARD RULE ================= */
function generateBoard(){
  let board=[], used=new Set();

  function rand(col){
    let min=col*10+1, max=col==8?90:col*10+9;
    return Math.floor(Math.random()*(max-min+1))+min;
  }

  for(let i=0;i<9;i++){
    let row=Array(9).fill("");
    let cols=[];
    while(cols.length<5){
      let c=Math.floor(Math.random()*9);
      if(!cols.includes(c)) cols.push(c);
    }

    cols.forEach(c=>{
      let n;
      do{ n=rand(c); }while(used.has(n));
      used.add(n);
      row[c]=n;
    });

    board.push(row);
  }
  return board;
}

function renderBoard(board){
  const table=document.getElementById("board");
  table.innerHTML="";
  board.forEach(r=>{
    let tr=document.createElement("tr");
    r.forEach(c=>{
      let td=document.createElement("td");
      td.innerText=c;
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}

/* ================= WIN CHECK ================= */
function checkWin(){
  let rows=document.querySelectorAll("#board tr");
  rows.forEach(r=>{
    let count=0;
    r.querySelectorAll("td").forEach(td=>{
      if(td.innerText && td.classList.contains("marked")) count++;
    });
    if(count==4) status.innerText="CHỜ";
    if(count==5) status.innerText="KINH";
  });
}
</script>

</body>
</html>
